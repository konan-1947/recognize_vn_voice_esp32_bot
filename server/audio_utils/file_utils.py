#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
File Utilities Module
Chá»©a cÃ¡c hÃ m xá»­ lÃ½ file chung cho server
"""

import os
import wave
import numpy as np
from datetime import datetime

def save_audio_to_wav(audio_data, filename, output_dir="test_recordings", 
                      sample_rate=16000, channels=1, sample_width=2):
    """
    LÆ°u audio data thÃ nh file WAV vá»›i thÃ´ng tin chi tiáº¿t
    
    Args:
        audio_data (bytes): Audio data dáº¡ng bytes
        filename (str): TÃªn file WAV
        output_dir (str): ThÆ° má»¥c output
        sample_rate (int): Sample rate (máº·c Ä‘á»‹nh: 16000)
        channels (int): Sá»‘ kÃªnh (máº·c Ä‘á»‹nh: 1 - mono)
        sample_width (int): Äá»™ rá»™ng sample (máº·c Ä‘á»‹nh: 2 - 16-bit)
    
    Returns:
        str: ÄÆ°á»ng dáº«n Ä‘áº¿n file WAV Ä‘Ã£ táº¡o, hoáº·c None náº¿u lá»—i
    """
    try:
        # Äáº£m báº£o audio data cÃ³ Ä‘á»™ dÃ i cháºµn (16-bit = 2 bytes)
        if len(audio_data) % 2 != 0:
            audio_data = audio_data[:-1]
        
        # Táº¡o file WAV
        wav_path = os.path.join(output_dir, filename)
        with wave.open(wav_path, 'wb') as wav_file:
            wav_file.setnchannels(channels)
            wav_file.setsampwidth(sample_width)
            wav_file.setframerate(sample_rate)
            wav_file.writeframes(audio_data)
        
        # TÃ­nh toÃ¡n thá»‘ng kÃª audio
        samples = np.frombuffer(audio_data, dtype=np.int16)
        rms = np.sqrt(np.mean(samples.astype(np.float32)**2))
        max_amplitude = np.max(np.abs(samples))
        min_amplitude = np.min(np.abs(samples))
        duration = len(samples) / sample_rate
        
        print(f"ğŸ’¾ WAV file saved: {wav_path}")
        print(f"ğŸ“Š Audio stats:")
        print(f"   â€¢ Size: {len(audio_data)} bytes")
        print(f"   â€¢ Samples: {len(samples)}")
        print(f"   â€¢ Duration: {duration:.2f}s")
        print(f"   â€¢ RMS: {rms:.1f}")
        print(f"   â€¢ Max amplitude: {max_amplitude}")
        print(f"   â€¢ Min amplitude: {min_amplitude}")
        print(f"   â€¢ Dynamic range: {20 * np.log10(max_amplitude / max(1, min_amplitude)):.1f} dB")
        
        return wav_path
        
    except Exception as e:
        print(f"âŒ Lá»—i lÆ°u WAV file: {e}")
        return None

def save_transcription_to_txt(transcription, filename, output_dir="test_recordings"):
    """
    LÆ°u káº¿t quáº£ nháº­n dáº¡ng vÃ o file txt
    
    Args:
        transcription (str): Text Ä‘Ã£ Ä‘Æ°á»£c nháº­n dáº¡ng
        filename (str): TÃªn file gá»‘c (Ä‘á»ƒ táº¡o tÃªn file txt)
        output_dir (str): ThÆ° má»¥c output
    
    Returns:
        str: ÄÆ°á»ng dáº«n Ä‘áº¿n file txt Ä‘Ã£ táº¡o, hoáº·c None náº¿u lá»—i
    """
    try:
        # Táº¡o tÃªn file txt
        txt_filename = filename.replace('.wav', '.txt')
        txt_path = os.path.join(output_dir, txt_filename)
        
        # LÆ°u transcription
        with open(txt_path, 'w', encoding='utf-8') as f:
            f.write(f"Transcription Result\n")
            f.write(f"=" * 50 + "\n")
            f.write(f"File: {filename}\n")
            f.write(f"Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"=" * 50 + "\n\n")
            
            if transcription:
                f.write(f"âœ… RECOGNIZED TEXT:\n")
                f.write(f"{transcription}\n")
            else:
                f.write(f"âŒ NO TEXT RECOGNIZED\n")
                f.write(f"Audio cÃ³ thá»ƒ quÃ¡ yáº¿u, cÃ³ tiáº¿ng á»“n cao, hoáº·c khÃ´ng cÃ³ giá»ng nÃ³i\n")
            
            f.write(f"\n" + "=" * 50 + "\n")
            f.write(f"Generated by Audio Test Recorder\n")
        
        print(f"ğŸ’¾ Transcription saved: {txt_path}")
        return txt_path
        
    except Exception as e:
        print(f"âŒ Lá»—i lÆ°u transcription: {e}")
        return None 